<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appeals - Clamping Business</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Appeals Management</h1>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <a href="/" class="btn">Back to Dashboard</a>

        <!-- Appeals Data -->
        <div class="appeals-section">
            <h2>All Appeals</h2>
            {% if appeals %}
                <table class="appeals-table">
                    <thead>
                        <tr>
                            <th>Appeal ID</th>
                            <th>Clamp ID</th>
                            <th>Location</th>
                            <th>Registration</th>
                            <th>Appeal Date</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appeal in appeals %}
                        <tr id="appeal-row-{{ appeal.id }}">
                            <td>#{{ appeal.id }}</td>
                            <td>#{{ appeal.clamp_id }}</td>
                            <td>{{ appeal.clamp.location if appeal.clamp else 'N/A' }}</td>
                            <td>{{ appeal.clamp.registration if appeal.clamp else 'N/A' }}</td>
                            <td>{{ appeal.appeal_date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ appeal.appeal_reason[:50] }}...</td>
                            <td>
                                <span class="status-{{ appeal.appeal_status.lower() }}">
                                    {{ appeal.appeal_status }}
                                </span>
                            </td>
                            <td>{{ appeal.notes or 'N/A' }}</td>
                            <td>
                                <button class="btn btn-edit btn-sm" onclick="editAppeal({{ appeal.id }})">Edit</button>
                                <button class="btn btn-print btn-sm" onclick="printAppeal({{ appeal.id }})">Print</button>
                                <a href="/delete-appeal/{{ appeal.id }}" class="btn btn-delete btn-sm" onclick="return confirm('Delete this appeal?')">Delete</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="no-data">No appeals found.</p>
            {% endif %}
        </div>
    </div>
    <script>
        function editAppeal(id) {
            const reason = prompt('Enter appeal reason:');
            const status = prompt('Enter status (Pending/Approved/Rejected):');
            const notes = prompt('Enter notes:');
            
            if (reason && status) {
                const formData = new FormData();
                formData.append('appeal_reason', reason);
                formData.append('appeal_status', status);
                formData.append('notes', notes || '');
                
                fetch(`/edit-appeal/${id}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }
        
        function printAppeal(id) {
            const appealRow = document.getElementById(`appeal-row-${id}`);
            if (!appealRow) return;
            const printWindow = window.open('', '', 'height=600,width=800');
            const appealHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Appeal #${id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .appeal-header { text-align: center; margin-bottom: 30px; }
                        .appeal-header h1 { margin: 0; color: #c3e6cb; }
                        .appeal-details { margin: 20px 0; line-height: 1.8; }
                        .detail-row { margin: 15px 0; padding: 10px; border-left: 3px solid #c3e6cb; }
                        .detail-row strong { color: #333; }
                        .footer { margin-top: 40px; border-top: 1px solid #ccc; padding-top: 20px; text-align: center; font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="appeal-header">
                        <h1>APPEAL DOCUMENT</h1>
                        <p>Appeal #${id}</p>
                    </div>
                    <div class="appeal-details">
                        <div class="detail-row"><strong>Appeal ID:</strong> ${appealRow.cells[0].textContent}</div>
                        <div class="detail-row"><strong>Clamp ID:</strong> ${appealRow.cells[1].textContent}</div>
                        <div class="detail-row"><strong>Location:</strong> ${appealRow.cells[2].textContent}</div>
                        <div class="detail-row"><strong>Registration:</strong> ${appealRow.cells[3].textContent}</div>
                        <div class="detail-row"><strong>Appeal Date:</strong> ${appealRow.cells[4].textContent}</div>
                        <div class="detail-row"><strong>Reason:</strong> ${appealRow.cells[5].textContent}</div>
                        <div class="detail-row"><strong>Status:</strong> ${appealRow.cells[6].textContent}</div>
                        <div class="detail-row"><strong>Notes:</strong> ${appealRow.cells[7].textContent}</div>
                    </div>
                    <div class="footer">
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                        <p>This is an official appeal document. Please keep for your records.</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(appealHTML);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
